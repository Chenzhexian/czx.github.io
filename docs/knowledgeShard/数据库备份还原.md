---
title: 数据库备份还原
---

## 备份
### 全量备份
#### shell脚本
自己写了个shell脚本，用于备份mysql数据库，使用mysqldump命令，备份到指定目录。
```shell
#!/bin/bash
#dir是备份文件要保存到的位置
dir="/czx_test/mysqlbackup"
#数据库账号密码和要备份的数据库,多个库使用空格隔开
mysqluser="用户名"
mysqlpwd="密码"
backupdatabases="库名1 库名2 库名3"
#目标用户@目标地址:目标路径
target="root@192.168.5.232:/目标路径"

if [ ! -d "$dir" ];then
mkdir -p $dir
echo "创建文件夹成功"
else
echo "文件夹已经存在"
fi

#执行备份操作 --databases后可以填多个库空格隔开  --all-databases备份所有库
echo `mysqldump -u$mysqluser -p$mysqlpwd  --skip-opt --single-transaction -q --databases $backupdatabases|gzip > $dir/mysqlbackup_$(date "+%Y-%m-%d").sql.gz`
echo "数据库备份成功"
echo `scp -r $dir $target`
echo "传输成功"
```

#### 操作步骤
```shell
#1.创建shell脚本  backup是脚本名
vim backup.sh
#给脚本添加执行权限
chmod +x backup.sh
#运行脚本 （当前目录下）
./backup.sh
#运行成功后出现如图的文件，拷贝到需要的服务器
```

![](https://czxcab.cn/file/docs/mysqlbackup1.jpg)

### 增量备份
修改mysql配置文件
```shell
#1.修改mysql配置
vim /etc/my.cnf

#2.配置文件[mysqld]下添加  
# /czx_test/mysqlbinlog是文件夹，mysql_binlog是文件名
log-bin=/czx_test/mysqlbinlog/mysql_binlog
binlog_format = MIXED
server-id=1

# 注意!!!!!!!  /czx_test/mysqlbinlog文件夹必须存在，并修改权限,
mkdir -p /czx_test/mysqlbinlog
chown -R mysql:mysql /czx_test/mysqlbinlog //mysql:mysql 第一用户，第二个用户组
chmod -R 755 /czx_test/mysqlbinlog

#然后重启mysql服务
service mysqld restart

#如果重启失败，将配置文件log-bin改成
log-bin=mysql_binlog //这样binlog日志就会生成到配置文件中datadir的位置
```

#### shell脚本
该脚本针对log-bin不能指定文件位置时使用
```shell
#!/bin/bash
#要保存的位置
dir="/czx_test/mysqlbinlog"
#数据库密码
mysqluser="用户名"
mysqlpwd="密码"
target="root@192.168.5.232:/目标路径"

rm -rf $dir
mkdir -p $dir
echo "创建文件夹成功"
#执行日志刷新，生成最新日志
echo `mysqladmin -u$mysqluser -p$mysqlpwd flush-logs`
#拷贝日志到指定位置  /var/lib/mysql这个目录是mysql配置文件中的datadir
cp -rf /var/lib/mysql/mysql_binlog.* $dir

echo `scp -r $dir $target`
echo "传输成功"
```

能指定bin-log的位置
```shell
#!/bin/bash
#数据库密码
mysqluser="用户名"
mysqlpwd="密码"
#dir是binlog文件保存的位置，也就是mysql配置文件中bin-log设置的位置
dir="/czx_test/mysqlbinlog"
target="root@192.168.5.232:/目标路径"

echo `mysqladmin -u$mysqluser -p$mysqlpwd flush-logs`
echo `scp -r $dir $target`
echo "传输成功"
```

#### 操作步骤
```shell
#1.创建shell脚本  mysqlbinlog是脚本名
vim mysqlbinlog.sh
#给脚本添加执行权限
chmod +x mysqlbinlog.sh
#运行脚本 （当前目录下）
./mysqlbinlog.sh
#运行成功后出现如图的文件，拷贝到需要的服务器
```

![](https://czxcab.cn/file/docs/mysqlbackup2.jpg)

## 还原
### 全量还原
```shell
#先解压
gzip -d 文件名
#然后执行sql
mysql -uroot -proot < backup.sql
```

补充

1. 从全备份中提取出该表的建表语句
```shell
sed -e'/./{H;$!d;}' -e 'x;/CREATE TABLE `表名`/!d;q' 全备库或导出的单库.sql > 表tt.sql
```
2. 提取该表的insert into语句,追加到上一个建库sql后
```shell
grep -i 'INSERT INTO `表名`' 全备库或导出的单库.sql >>表tt.sql
```
### 增量还原
binlog的具体用法可以看这篇文章：[mysqlbinlog的使用](mysqlbinlog的使用.md)
```shell
# --start-position='13202' 开始节点
# --stop-position='13506'  结束节点
# --stop-datetime='2021-02-06 15:58:39'  开始时间
# --start-datetime='2021-02-06 15:58:39'  结束时间
# --database=数据库名 指定某个数据库的操作
mysqlbinlog --database=数据库名 mysql_binlog.000001|mysql -uroot -proot

#查看binlog文件
mysqlbinlog --no-defaults --base64-output=decode-rows -v mysql_binlog.000001
```

::: warning 注意
如果发现有命令不存在的，请看下面指令
:::

```shell
#使用find找到该文件位置，比如mysqlbinlog命令不存在
cd /
find -name mysqlbinlog

#找到后,在/usr/local/bin中创建软连接
cd /usr/local/bin
ln -s 文件位置/mysqlbinlog mysqlbinlog
```

## crontab定时任务
```shell
#crontab -l 查看所有定时任务
#crontab -e 开始编辑定时任务

#进入编辑后 使用全路径
* * * * * 全路径/backup.sh
#时间规则如下
```
![](https://czxcab.cn/file/docs/mysqlbackup3.jpg)
