---
title: 《MySQL是怎样运行的》
---

## 第一章 初始MySQL

### 1.1 MySQL 的客户端/服务器架构
MySQL分为`客户端`和`服务器`两个程序，它的服务器程序直接与要存储的数据打交道，多个客户端程序可以连接到这个服务器程序，向服务器发送增删改查的请求，然后服务器程序根据这些请求，对存储的数据进行相应处理。MySQL 的日常使用场景是下面这样的：
1. 启动 MySQL 服务器程序。
2. 启动 MySQL 客户端程序，并连接到服务器程序。
3. 在客户端程序中输入命令语句，并将其作为请求发送给服务器程序。服务器程序在收到这些请求后，根据请求的内容来操作具体的数据，并将结果返回给客户端。

>MySQL 服务器程序的进程称为 MySQL 数据库实例( instance )

### 1.2 MySQL 的安装
无论是通过下载源代码的方式自行编译安装 还是直接使用官方提供的安装包进行安装， MySQL 的服务器程序和客户端程序都会安装到机器上。

:::warning 一定一定一定要记住 MySQ 的安装目录
:::

#### 1.2.1 bin目录下的可执行文件
MySQL 的安装目录下有一个特别重要的 bin 目录，这个目录存放着许多可执行文件。这里仅列出了部分，如下图所示：

![](https://czxcab.cn/file/docs/1705892867878.jpg)

MySQL可执行文件有很多，例如我们常用的 mysqld 文件，这些文件可以通过相对/绝对路径来调用，也可以配置环境变量，更方便地使用。

>配置环境变量大家应该都很熟悉，这里就不再赘述了。

### 1.3 MySQL服务器程序
这节主要介绍 MySQL 一些常用服务器程序的作用，简单了解即可。
1. `mysqld`
可执行文件就表示MySQL服务器程序，运行这个可执行文件就可以直接启动一个MySQL服务器进程。

2. `mysqld_safe`
是一个启动脚本，它会间接调用 `mysqld` 并持续监控服务器的运行状态。当服务器进程出现错误时，它还可以帮助重启服务器程序。另外，使用 `mysqld_safe` 启动MySQl服务器程序时，它会将服务器程序的出错信息和其他诊断信息输出到错误日志，以方便后期查找发生错误的原因。

3. `mysqlserver` 
也是一个启动脚本（其实是一个链接文件，实际文件是/supportfiles/mysqlserver），它会间接地调用 `mysqld_safe`。可以启动服务器程序，也可以停止服务器程序。
    ```shell
    mysql.server start
    mysql.server stop
    ```
4. `mysqld_multi` 运行多个服务器实例，也就是运行多个MySQL服务器进程，也能报告它们的运行状态。

### 1.4 启动 MySQL客户端程序
执行下面命令，即可启动 MySQL 客户端程序。
```shell
mysql -h主机名 -u用户名 -p密码
```

### 1.5 客户端与服务器连接的过程
MySQL支持下面几种客户端进程和服务器进程的通信方式
- TCP/IP
- 命名管道或共享内存
- UNIX 域套接字

### 1.6 服务器处理客户端请求
客户端进程向服务器进程发送一段SQL，服务器进程处理后再向客户端进程返回处理结果。那么 ，服务器进程对客户端迸程发送的请求做了什么处理，如下图所示：

![](https://czxcab.cn/file/docs/1705894542234.jpg)

### 1.7 常用存储引擎
MySQL 服务器程序支持多种存储引擎，每种存储引擎都有自己的特点，MySQL支持的存储引擎看下图。

![](https://czxcab.cn/file/docs/1705894677143.jpg)

### 1.8 关于存储引擎的一些操作
#### 1.8.1 查看当前服务器程序支持的存储引擎
```mysql
SHOW ENGINES;
```
调用效果如下：

![](https://czxcab.cn/file/docs/1705894969859.jpg)

- `Support`列表示该存储引擎是否可用
- `DEFAULT` 值代表当前服务器程序的默认存储引擎
- `Comment` 列是对存储引擎的一个描述
- `Transactions` 列代表该存储引擎是否支持事务处理
- `XA` 列代表该存储引擎是否支持分布式事务
- `Savepoints` 列代表该存储引擎是否支持事务的部分回滚

#### 1.8.2 设置表的存储引擎
创建新表时使用:
```mysql
CREATE TABLE 表名{
建表语句;
   } ENGINE = 存储引擎名称;
```

现有表要修改:
```mysql
ALTER TABlE 表名 ENGINE = 存储引擎名称，
```

## 第二章 MySQL启动选项和系统变量
### 2.1 启动选顶和配置文件
简单来说，启动选项就是命令行参数，可以配置MySQL服务器程序的行为，也可以修改配置文件来实现。
#### 2.1.1 在命令行上使用选项
禁止各客户端使用 TCP/IP网络进行通信
```shell
mysqld --skip-networking
#等价于
mysqld --skip_networking
```
- 指定启动选项时需要在选项名前加上`--`前缀
- 如果选项名是由多个单词构成的，它们之间可以由短划线`-`连接，也可以使用下划线`_`连接
- 选项名、=、选项值之间不可以有空白字符

![](https://czxcab.cn/file/docs/1705972190491.jpg)

#### 2.1.2 配置文件中使用选项
在命令行中设置的启动选项只在当次启动生效，如果想让设置永久生效，就需要在配置文件中进行设置。

##### 1. 配置文件的路径
windows操作系统下，MySQL会依次在下面几个目录中查找配置文件：

![](https://czxcab.cn/file/docs/1705981853824.jpg)
- 在给定的前3个路径中，配置文件可以使用`ini`的扩展名，也可以使用`cnf`的扩展名
- `%WINDIR%` 指的是你的机器上 Windows 目录的位置，可以使用 `echo %WINDIR%` 命令查看
- `BASEDIR` 指的 MySQL 安装目录的路径
- 第四个路径指的是在启动程序时可以通过指定 `defaults-extrn-file` 启动选项的值来添加额外的配置文件路径。比如，我们在命令行中可以这么写：
   ```shell
   mysqld --defaults-extra-file=C:\Users\xiaohaizi4919\my_extrafile.txt
   ```
- `%APPDATA%` 表示 Windows 应用程序数据目录的值，可以使用 `echo %APPDATA%` 命令查看
- 最后一个名为`mylogin.cnf`的配置文件它不是一个纯文本文件(其他的配置文件都是纯文本文件)，而是使用`mysql_config_editor`实用程序创建的加密文件。这个文件只能包含一些在启动客户端程序时用于连接服务器的选项，包括host、user、password、port 和 socket，而且它只能被客户端程序所使用。

在类 UNIX 操作系统中，MySQL会依次在下面几个目录中查找配置文件：

![](https://czxcab.cn/file/docs/1705987269336.jpg)
![](https://czxcab.cn/file/docs/1705987284753.jpg)

##### 2. 配置文件的内容
在配置文件中，我们会看到类似[server]、[mysqld]等这样的选项组，不同的选项组是给不同的程序使用的.如果选项组名称与程序名称相同，则组中的选项将专门应用于该程序，有两个比较特殊：
- [server] 组下面的启动选项将作用于所有的服务器程序
- [client] 组下面的启动选项将作用于所有的客户端程序

![](https://czxcab.cn/file/docs/1705988496890.jpg)

##### 3. 特定MySQL版本的专用选项组
我们可以在选项组的名称后加上特定的MySQL版本号。比如对于`[mysqld]`选项组来说我们可以定义一个`[mysqld-5.7]`的选项组。它的含义和`[mysqld]`一样，只不过只有版本号为`5.7`的mysqld程序才能使用这个选项组中的选项。

##### 4. 配置文件的优先级
上面有提到了MySQL读取配置文件的顺序，如果我们在多个配置文件中设置了相同的选项，则以**最后读取到的配置文件中的选项为准**。

##### 5. 同一个配置文件中多个组的优先级
同一个配置文件中不同选项组配置了相同的选项，**以最后一个为准**，比如下面这个配置文件以`[mysqld]`的配置为准
```shell
[server]
default-storage-engine=InnoDB
[mysqld]
default-storage-engine=MyISAM
```

##### 6. defaults-file的使用
如果我们不想让MySQL到默认的路径下搜索配置文件，则可以在命令行指定`defaults-file`选项，例如：
```shell
mysqld --defaults-file-/tmp/myconfig.txt
```
这样一来，在程序启动时将只在`/tmp/myconfig.txt`路径下搜索配置文件，如果文件不存在或无法访问，则会发生错误

:::warning 小贴士
注意`defaults-extra-file`和`defaults-file`的区别，使用`defaults-extra-fle`可以指定额外的配置文件路径(也就是说那些固定的配置文件路径也会被搜索)
:::

#### 2.1.3 在命令行和配置文件中启动选顶的区别
在命令行中指定的绝大部分启动选项都可以放到配置文件中，但是有一些选项是专门为命令行设计的，比如`defaults-extra-file`和`defaults-file`这样的选项本身就是为了指定配置文件路径的，如果再放在配置文件中就没啥意义了

**另外有一点需要特别注意**:如果同一个启动选项既出现在命令行中，又出现在配置文件中，那么**以命令行中的启动选项为准**！

### 2.2 系统变量
#### 2.2.1 系统变量简介
MySQL 服务器程序在运行过程中会用到许多影响程序行为的变量，它们被称为系统变量。比如，允许同时连入的客户端数量用系统变量`max_connections`表示;每个系统变量都有一个默认值，我们可以使用命令行或者配置文件中的选项在启动服务器时改变一些系统变量的值。大多数系统变量的值也可以在程序运行过程中修改，而无须停止并重新启动服务器。

#### 2.2.2 查看系统变量
使用下面命令可以查看MySQL的系统变量，系统变量太多，想要找指定的可以加上 `like` 进行查询
```mysql
show variables
show variables like 'max_connections'
show variables like 'max_%'
```

![](https://czxcab.cn/file/docs/1705993088059.jpg)

#### 2.2.3 设置系统变量
##### 1. 通过启动选项设置
就是上面说的两种设置方式，在命令行和配置文件中都可以设置。
##### 2. 服务器程序运行过程中设置
(1) 设置不同作用范围的系统变量

系统变量分为两大类，一类是全面变量，另一类是会话变量。
- `GLOBAL`(全局范围):影响服务器的整体操作。具有 `GLOBAL`作用范围的系统变量可以称为全面变量。
- `SESSION`(会话范围):影响某个客户端连接的操作。具有 `SESSION`作用范围的系统变量可以称为会话变量。

简单来说`GLOBAL`范围的系统变量会影响到整个服务器程序，而`SESSION`范围的系统变量只影响当前客户端连接，换成大白话说就是，用户如果不去设置`SESSION`范围的系统变量，那就都按`GLOBAL`范围的来。

设置系统变量的语法:
```mysql
SET [GLOBAL|SESSION] 系统变量名 = 值;
SET [@@(GLOBAL|SESSION).]系统变量名 = 值;
```
示例
```mysql
#GLOBAL
SET GLOBAL default_storage_engine = MyISAM;
SET @@GLOBAL.default_storage_engine = MyISAM;
#SESSION
SET SESSION defau1t_storage_engine = MyISAM;
SET @@SESSION.defaulUtorage_engine=MyISAM;
SET default_storage_engine = MyISAM;
```
>可以看出，如果在设置系统变量的语句中省略了作用范围，默认的作用范围就是`SESSION`

(2) 查看不同作用范围的系统变量
命令如下：
```mysql
SHOW [GLOBAL|SESSION] VARIABLES [LIKE '系统变量名'];
```
- 如果使用`GLOBAL`修饰符，则显示全局系统变量的值。如果某个系统变量没有`GLOBAL`作用范围，则不显示它。
- 如果使用`SESSION`修饰符，则显示针对当前连接有效的系统变量值。如果某个系统变量没有`SESSION`作用范围，则显示`GLOBAL`作用范围的值。
- 如果没写修饰符，则与使用`SESSION`修饰符效果一样。

:::warning 小贴士
如果某个客户端改变某个系统变量在`GLOBAL`作用范围的值，并不会影响该系统变量在当前已经连接的客户端作用范围为`SESSION`的值，只会影响后续连入的客户端作用范围`SESSION`的值
:::

(3) 注意事项
- 并不是所有的系统变量都具有`GLOBAL`和`SESSION`的作用范围。
  - 有一些系统变量只具有`GLOBAL`作用范围，比如`max_connections`
  - 有一些系统变量只具有`SESSION`作用范围，比如`insert_id`，它表示在对某个包含`AUTO_INCREMENT`列的表进行插入时，该列初始的值。
  - 有一些系统变量的值既具有`GLOBAL`作用范围，也具有`SESSION`作用范围，比如前面用到的`default_storage_engine`，大部分的系统变量都是这样的。
- 有些系统变量是只读的，并不能设置值，比如`version`

##### 3. 启动选项和系统变量的区别
- 大部分的系统变量都可以当作启动选项传入
- 有些系统变量是在程序运行过程中自动生成的，不可以当作启动选项来设置，比如`character_set_client`
- 有些启动选项也不是系统变量，比如`defaults-file`

### 2.3 状态变量
MySQL 服务器程序中维护了好多关于程序运行状态的变量。比如，`Treads_connected` 表示当前有多少客户端与服务器建立了连接; `Innodb_rows_updated` 表示更新了多少条以 Innodb 为存储引擎的表中的记录

状态变量和系统变量类似，也有`GLOBAL`和`SESSION`两种作用范围，使用语法也是一样的。
```mysql
SHOW [GLOBAL|SESSION] STATUS[LIKE匹配的模式];
# 示例
SHOW STATUS LIKE 'thread%'
```
![](https://czxcab.cn/file/docs/1706150272166.jpg)
## 第三章 字符集和比较规则
### 3.1 字符集和比较规则简介
#### 3.1.1 字符集简介
计算机实际存储的是二进制数据，那他是怎么存储字符串的呢?当然是建立字符集，比如`ASCII`字符集，`GBK`字符集等。这些字符集的作用就是将字符和二进制数据建立映射关系。将字符映射成二进制数据的过程叫作编码，将二进制数据映射到字符的过程叫作解码

举个例子，`ASCII`字符集将字符`A`映射为二进制数据`01000001`，而`GBK`字符集将字符`A`映射为二进制数据`10000001 01000001`。

#### 3.1.2 比较规则简介
如何比较两个字符串的大小呢?最简单的方法就是比较两个字符串的二进制数据，也称二进制比较规则。但是实际生活中我们有很多不同类型的字符，比如中文字符，比较这些字符就要使用不同的比较规则。

#### 3.1.3 一些重要的字符集
- `ASCII`字符集:共收录128个字符，由于`ASCII`字符集总共才 128 个字符，所以可以使用一个字节来进行编码。
- `ISO 8859-1`字符集:共收录 256个字符，它在ASCII字符集的基础上又扩充了128个西欧常用字符。`ISO 889-1`字符集也可以使用一个字节来进行编码。
- `GB2312`字符集:收录了汉字以及拉丁字母、希腊字母等。这种字符集同时又兼容`ASCII`字符集，所以在编码方式上显得有些奇怪:如果该字符在`ASCII`字符集中，则采用一字节编码，否则采用两字节编码。
- `GBK`字符集:`GBK`字符集只是在收录的字符范围上对 `GB2312`字符集进行了扩充，编码方式兼容`GB2312`字符集。
- `UTF-8`字符集:几乎收录了当今世界各个国家/地区使用的字符，兼容ASCII字符集，采用变长编码方式，编码一个字符时需要使用1~4字节。

:::tip 补充说明
这里说到的一个字节其实就是8位，这里的位其实就是0或1，比如字符`A`使用一个字节来编码，二进制数据是`01000001`，数一下一共就是8位。
:::

### 3.2 MySQL中支持的字符集和比较规则
#### 3.2.1 MySQL中的utf8和utf8mb4
在MySQL中，字符集表示一个字符所用的最大字节长度在某些方面会影响系统的存储和性能。设计 MySOL的大叔“偷偷”地定义了下面两个概念
- `utf8mb3`:“阉割”过的UTF-8 字符集，只使用1~3字节表示字符 (utf8是utf8mb3的别名)
- `utf8mb4`:正宗的UTF-8字符集，使用1~4字节表示字符。

>在MySQL8.0中，设计MySQL的大叔已经很大程度地优化了 `utf8mb4` 字符集的性能，而且已经将其设置为默认的字符集。

#### 3.2.2 字符集的查看
```mysql
SHOW (CHARACTER SET|CHARSET) [LIKE 匹配的模式]
```

![](https://czxcab.cn/file/docs/1706178739078.jpg)

注意返回结果中的最后一列`Maxlen`，它代表这种字符集最多需要几个字节来表示一个字符，下面是这几个常见的字符集:

![](https://czxcab.cn/file/docs/1706178890798.jpg)

#### 3.2.3 比较规则的查看
```mysql
SHOW COLLATION [LIKE 匹配的模式]
```
比较规则的名称都是有规律的。比如`utf8_polish_ci`表示波兰语的比较规则，`utf8_spanish_ci`表示班牙语的比较规则;名称后缀意味着该比较规则是否区分语言中的重音、大小写等如下图

![](https://czxcab.cn/file/docs/1706179247905.jpg)

### 3.3 字符集和比较规则的应用
#### 3.3.1 各级别的字符集和比较规则
MySQL有4个级别的字符集和比较规则，分别是服务器级别、数据库级别、表级别、列级别。

##### 1. 服务器级别
MySQL 提供了两个系统变量来表示服务器级别的字符集和比较规则

|系统变量|描述|
|--|--|
|character_set_server|服务器级别的字符集|
|collation_server|服务器级别的比较规则|

这两个系统变量可以通过启动选项或者在服务器程序运行过程中使用SET语句来修改这两个变量的值。也可以在配置文件中直接修改:
```shell
[server]
character_set_server=gbk
collation_server=gbk_chinese_ci
```

##### 2. 数据库级别
创建和修改数据库时可以指定该数据库的字符集和比较规则:

```mysql
[CREATE|ALTER] DATABASE 数据库名
[CHARACTER SET 字符集名称]
[COLLATE 比较规则名称];
# 示例
CREATE DATABASE db1
CHARACTER SET gbk
COLLATE gbk_chinese_ci;
```

查看当前数据库使用的字符集和比较规则，可以查询下面两个变量，前提先切到对应数据库:
```mysql
USE db1

SHOW VARIABLES LIKE 'character_set_database'
SHOW VARIABLES LIKE 'collation_database'
```
|系统变量| 描述         |
|--|------------|
|character_set_database| 当前数据库的字符集  |
|collation_database| 当前数据库的比较规则 |

建数据库时如果没有指定字符集和比较规则，则使用服务器级别的字符集和比较规则。

##### 3. 表级别
创建和修改表时可以指定该表的字符集和比较规则:
```mysql
CREATE TABLE 表名 (列的信息)
[CHARACTER SET 字符集名称]
[COLLATE 比较规则名称]
```
如果表创建时没有指定字符集和比较规则，则使用数据库级别的字符集和比较规则。

##### 4. 列级别
```mysql
CREATE TABLE 表名(
    列名 字符串类型 [CHARACTER SET 字符集名称] [COLLATE比较规则名称]
        其他列...
);

ALTER TABLE 表名 MODIFY 列名 字符串类型 [CHARACTER SET字符集名称] [COLLATE 比较规则名称];
```
和上面一样，如果没有指定列的字符集和比较规则，则使用表级别的字符集和比较规则。

:::warning 小贴士
在修改列的字符集时需要注意，如果列中存储的数据不能用修改后的字符集进行表示，则会发生错误。

比如，列最初使用的字符集是 `utf8`，列中存储了一些汉字，现在把列的字符集转换为`ascii` 的话就会出错，因为`ascii` 字符集并不能表示汉字字符。
:::

##### 5. 仅修改字符集或仅修改比较规则
- 只修改字符集，则比较规则将变为修改后的字符集默认的比较规则
- 只修改比较规则，则字符集将变为修改后的比较规则对应的字符集

#### 3.3.2 客户端和服务器通信过程中使用的字符集
##### 1. 编码和解码使用的字符集不一致
其实就是乱码的原因，比如你使用utf-8进行了编码，然后使用GBK进行解码，每种字符集中的字节都可能对应不同的字符所以就产生了乱码

##### 2. 字符集转换的概念
如果一个程序接收到字节序列0xE68891，并按照`UTF-8`解码，然后再按照`GBK`编码，最终得到的字节序列是0xCED2。这个过程被称为字符集的转换。

##### 3. MySQL中的字符集转焕过程
客户端在编码请求字符串时实际使用的字符集，与服务器在收到一个字节序列后认为该字节序列所采用的编码字符集，是两个独立的字符集。
###### 客户端发送请求
- Linux操作系统下查看字符集
    ```shell
    echo $LC_ALL
    echo $LC_CTYPE
    echo $LANG
    ```
- Windows操作系统下查看字符集

  在Windows命令行窗口的标题栏上单击鼠标右键，选择`属性`，点击 `选项`，可以看到是GBK字符集
  ![](https://czxcab.cn/file/docs/1707185313252.jpg)

###### 服务器接收请求
服务器接收到的请求就是一个字节序列，它将这个字节序列看作是使用系统变量`character_set_ client`代表的字符集进行编码的字节序列（每个客户端与服务器建立连接后，服务器都会为该客户端维护一个单独 `character_set_client` 变量，这个变量是 `SESSION` 级别的）
